; Emergency WiFi Bridge - POC Configuration
; Heltec WiFi LoRa 32 V2 with WiFi AP + Bluetooth enabled
; Full networking: DHCP server, packet routing, connection management

[env:heltec-v2-pwa-poc]
board_level = extra
extends = esp32_base
board = heltec_wifi_lora_32_V2

build_flags =
  ${esp32_base.build_flags}
  -D HELTEC_V2_0
  -I variants/esp32/heltec_v2

  ; Enable WiFi AP features
  -D ENABLE_WIFI_AP=1
  -D ENABLE_EMERGENCY_BRIDGE=1

  ; Disable Bluetooth (conflicts with WiFi AP on ESP32)
  -D MESHTASTIC_EXCLUDE_BLUETOOTH=1
  -D DISABLE_BLUETOOTH=1
  -D CONFIG_BT_ENABLED=0

  ; Disable GPS to save memory
  -D MESHTASTIC_EXCLUDE_GPS=1

  ; Pre-configure LoRa region (EU = 868 MHz, no setup prompt)
  ; For US use: meshtastic_Config_LoRaConfig_RegionCode_US
  -D USERPREFS_CONFIG_LORA_REGION=meshtastic_Config_LoRaConfig_RegionCode_EU_868

  ; LWIP Network Stack Configuration (increased limits for WiFi AP + routing)
  -D CONFIG_LWIP_MAX_ACTIVE_TCP=32
  -D CONFIG_LWIP_MAX_LISTENING_TCP=16
  -D CONFIG_LWIP_MAX_SOCKETS=16
  -D MEMP_NUM_TCP_PCB=20
  -D MEMP_NUM_TCP_PCB_LISTEN=8
  -D MEMP_NUM_UDP_PCB=16
  -D MEMP_NUM_NETCONN=16
  -D MEMP_NUM_NETBUF=16
  -D PBUF_POOL_SIZE=32
  -D TCP_MSS=1460
  -D TCP_SND_BUF=5840
  -D TCP_WND=5840

  ; WiFi Performance Tuning
  -D CONFIG_ESP32_WIFI_STATIC_RX_BUFFER_NUM=16
  -D CONFIG_ESP32_WIFI_DYNAMIC_RX_BUFFER_NUM=32
  -D CONFIG_ESP32_WIFI_TX_BUFFER_TYPE=1
  -D CONFIG_ESP32_WIFI_DYNAMIC_TX_BUFFER_NUM=32
  -D CONFIG_ESP32_WIFI_AMPDU_TX_ENABLED=1
  -D CONFIG_ESP32_WIFI_AMPDU_RX_ENABLED=1

  ; Debug flags
  -D DEBUG_PORT=Serial
  -D CORE_DEBUG_LEVEL=3

; Additional libraries for WiFi AP and WebSocket
lib_deps =
  ${esp32_base.lib_deps}
  https://github.com/me-no-dev/ESPAsyncWebServer.git
  https://github.com/Links2004/arduinoWebSockets.git
  bblanchon/ArduinoJson@^6.21.3

; Exclude Bluetooth libraries (saves memory and prevents conflicts)
lib_ignore =
  NimBLE-Arduino
  ESP32 BLE Arduino

; Exclude Bluetooth source files
build_src_filter =
  ${esp32_base.build_src_filter}
  -<nimble/>
  -<bluetooth/>
  -<BluetoothCommon.cpp>

; SPIFFS for web app storage - use huge_app partition for POC
board_build.filesystem = littlefs
board_build.partitions = huge_app.csv

; Monitor settings
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
